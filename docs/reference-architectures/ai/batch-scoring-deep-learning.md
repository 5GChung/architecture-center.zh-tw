---
title: Azure 上適用於深入學習模型的批次評分
description: 此參考架構會示範如何使用 Azure Batch AI 將類神經樣式傳輸套用到影片
author: jiata
ms.date: 10/02/2018
ms.author: jiata
ms.openlocfilehash: 1f3f3d3882b2b30eb29acd26c9eab9ff128028e2
ms.sourcegitcommit: 9eecff565392273d11b8702f1fcecb4d75e27a15
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/03/2018
ms.locfileid: "48243718"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="d283a-103">Azure 上適用於深入學習模型的批次評分</span><span class="sxs-lookup"><span data-stu-id="d283a-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="d283a-104">此參考架構會示範如何使用 Azure Batch AI 將類神經樣式傳輸套用到影片。</span><span class="sxs-lookup"><span data-stu-id="d283a-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="d283a-105">「樣式傳輸」是一種深入學習技術，可使用另一個影像的樣式來編撰現有影像。</span><span class="sxs-lookup"><span data-stu-id="d283a-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="d283a-106">此架構可以廣泛應用到任何搭配使用深入學習的批次評分案例。</span><span class="sxs-lookup"><span data-stu-id="d283a-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="d283a-107">[**部署這個解決方案**](#deploy-the-solution)。</span><span class="sxs-lookup"><span data-stu-id="d283a-107">[**Deploy this solution**](#deploy-the-solution).</span></span>
 
![](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="d283a-108">**案例**：媒體組織想要讓他們的影片樣式看起來像是特定畫作。</span><span class="sxs-lookup"><span data-stu-id="d283a-108">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="d283a-109">組織想要及時且自動地將此樣式套用至影片的所有畫面。</span><span class="sxs-lookup"><span data-stu-id="d283a-109">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="d283a-110">如需類神經樣式傳輸演算法的詳細背景，請參閱[使用卷積神經網路的影像樣式傳輸][image-style-transfer] (PDF)。</span><span class="sxs-lookup"><span data-stu-id="d283a-110">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="d283a-111">樣式影像：</span><span class="sxs-lookup"><span data-stu-id="d283a-111">Style image:</span></span> | <span data-ttu-id="d283a-112">輸入/內容影片：</span><span class="sxs-lookup"><span data-stu-id="d283a-112">Input/content video:</span></span> | <span data-ttu-id="d283a-113">輸出影片：</span><span class="sxs-lookup"><span data-stu-id="d283a-113">Output video:</span></span> | 
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="d283a-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "輸入影片") 按一下以檢視影片</span><span class="sxs-lookup"><span data-stu-id="d283a-114">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="d283a-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "輸出影片") 按一下以檢視影片</span><span class="sxs-lookup"><span data-stu-id="d283a-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="d283a-116">此參考架構適用於當 Azure 儲存體中有新媒體出現時就會觸發的工作負載。</span><span class="sxs-lookup"><span data-stu-id="d283a-116">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="d283a-117">處理程序包含下列步驟：</span><span class="sxs-lookup"><span data-stu-id="d283a-117">Processing involves the following steps:</span></span>

1. <span data-ttu-id="d283a-118">上傳選取的樣式影像 (例如梵谷的畫作) 和樣式傳輸指令碼到 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="d283a-118">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="d283a-119">建立已準備好開始進行工作的自動調整 Batch AI 叢集。</span><span class="sxs-lookup"><span data-stu-id="d283a-119">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="d283a-120">將影片檔案分割成個別畫面，並將這些畫面上傳到 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="d283a-120">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="d283a-121">上傳所有畫面之後，將觸發程序檔案上傳至 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="d283a-121">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="d283a-122">這個檔案會觸發邏輯應用程式，此應用程式會建立一個在 Azure 容器執行個體中執行的容器。</span><span class="sxs-lookup"><span data-stu-id="d283a-122">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="d283a-123">該容器會執行指令碼來建立 Batch AI 作業。</span><span class="sxs-lookup"><span data-stu-id="d283a-123">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="d283a-124">每項作業都會將類神經樣式傳輸平行套用到 Batch AI 叢集的節點上。</span><span class="sxs-lookup"><span data-stu-id="d283a-124">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="d283a-125">一旦產生影像時，系統就會將這些影像存回 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="d283a-125">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="d283a-126">下載產生的畫面，然後將影像拼接到影片中。</span><span class="sxs-lookup"><span data-stu-id="d283a-126">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="d283a-127">架構</span><span class="sxs-lookup"><span data-stu-id="d283a-127">Architecture</span></span>
<span data-ttu-id="d283a-128">此架構由下列元件組成。</span><span class="sxs-lookup"><span data-stu-id="d283a-128">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="d283a-129">計算</span><span class="sxs-lookup"><span data-stu-id="d283a-129">Compute</span></span>

<span data-ttu-id="d283a-130">**[Azure Batch AI][batch-ai]** 會用來執行類神經樣式傳輸演算法。</span><span class="sxs-lookup"><span data-stu-id="d283a-130">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="d283a-131">Batch AI 藉由提供容器化的環境來支援深入學習工作負載，此環境位在已啟用 GPU 的 VM 上，並已針對深入學習架構進行預先設定。</span><span class="sxs-lookup"><span data-stu-id="d283a-131">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="d283a-132">Batch AI 也可以將計算叢集連線到 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="d283a-132">Batch AI can also connect the compute cluster to Blob storage.</span></span>

### <a name="storage"></a><span data-ttu-id="d283a-133">儲存體</span><span class="sxs-lookup"><span data-stu-id="d283a-133">Storage</span></span>

<span data-ttu-id="d283a-134">**[Blob 儲存體][blob-storage]** 會用來儲存所有影像 (輸入影像、樣式影像與輸出影像)，以及所有 Batch AI 所產生的記錄。</span><span class="sxs-lookup"><span data-stu-id="d283a-134">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="d283a-135">Blob 儲存體會透過 [blobfuse][blobfuse] 與 Batch AI 整合，blobfuse 是由 Blob 儲存體支援的開放原始碼虛擬檔案系統。</span><span class="sxs-lookup"><span data-stu-id="d283a-135">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="d283a-136">對於此工作負載需要的效能，Blob 儲存體也非常符合成本效益。</span><span class="sxs-lookup"><span data-stu-id="d283a-136">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="d283a-137">觸發程序/排程</span><span class="sxs-lookup"><span data-stu-id="d283a-137">Trigger / scheduling</span></span>

<span data-ttu-id="d283a-138">**[Azure Logic Apps][logic-apps]** 會用來觸發工作流程。</span><span class="sxs-lookup"><span data-stu-id="d283a-138">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="d283a-139">當邏輯應用程式偵測到 Blob 已新增至容器時，就會觸發 Batch AI 程序。</span><span class="sxs-lookup"><span data-stu-id="d283a-139">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="d283a-140">Logic Apps 十分適合此參考架構，因為用它來偵測 Blob 儲存體的變更相當容易，並且還提供簡單的程序來變更觸發程序。</span><span class="sxs-lookup"><span data-stu-id="d283a-140">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="d283a-141">**[Azure 容器執行個體][container-instances]** 會用來執行建立 Batch AI 作業的 Python 指令碼。</span><span class="sxs-lookup"><span data-stu-id="d283a-141">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="d283a-142">在 Docker 容器內執行這些指令碼相當方便，您可以視需求來執行指令碼。</span><span class="sxs-lookup"><span data-stu-id="d283a-142">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="d283a-143">我們會針對此架構使用容器執行個體，因為這可使用預先建置的邏輯應用程式連接器，讓邏輯應用程式觸發 Batch AI 作業。</span><span class="sxs-lookup"><span data-stu-id="d283a-143">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="d283a-144">容器執行個體可以快速地開始運作無狀態程序。</span><span class="sxs-lookup"><span data-stu-id="d283a-144">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="d283a-145">**[DockerHub][dockerhub]** 會用來儲存 Docker 映像，容器執行個體會使用此映像來執行作業建立程序。</span><span class="sxs-lookup"><span data-stu-id="d283a-145">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="d283a-146">此架構已選擇使用 DockerHub，因為它容易使用，而且是 Docker 使用者的預設映像存放庫。</span><span class="sxs-lookup"><span data-stu-id="d283a-146">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="d283a-147">您也可以使用 [Azure Container Registry][container-registry]。</span><span class="sxs-lookup"><span data-stu-id="d283a-147">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="d283a-148">資料準備</span><span class="sxs-lookup"><span data-stu-id="d283a-148">Data preparation</span></span>

<span data-ttu-id="d283a-149">此參考架構會使用有一隻猩猩在樹上的影片畫面。</span><span class="sxs-lookup"><span data-stu-id="d283a-149">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="d283a-150">您可以從[此處][source-video]下載該畫面，然後遵循下列步驟來處理此畫面，以便用於工作流程：</span><span class="sxs-lookup"><span data-stu-id="d283a-150">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="d283a-151">使用 [AzCopy][azcopy] 從公用 Blob 下載影片。</span><span class="sxs-lookup"><span data-stu-id="d283a-151">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="d283a-152">使用 [FFmpeg][ffmpeg] 擷取音訊檔案，以便稍後可以將音訊檔案拼接回輸出影片。</span><span class="sxs-lookup"><span data-stu-id="d283a-152">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="d283a-153">使用 FFmpeg 將影片分成個別的畫面。</span><span class="sxs-lookup"><span data-stu-id="d283a-153">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="d283a-154">畫面會以平行方式獨立處理。</span><span class="sxs-lookup"><span data-stu-id="d283a-154">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="d283a-155">使用 AzCopy 將個別畫面複製到您的 Blob 容器。</span><span class="sxs-lookup"><span data-stu-id="d283a-155">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="d283a-156">在此階段，影片畫面的形式已可以用於類神經樣式傳輸。</span><span class="sxs-lookup"><span data-stu-id="d283a-156">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span> 

## <a name="performance-considerations"></a><span data-ttu-id="d283a-157">效能考量</span><span class="sxs-lookup"><span data-stu-id="d283a-157">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="d283a-158">GPU 與 CPU</span><span class="sxs-lookup"><span data-stu-id="d283a-158">GPU vs CPU</span></span>

<span data-ttu-id="d283a-159">針對深入學習工作負載，GPU 的效能通常遠勝於 CPU，但若只能使用 CPU，通常需要大量 CPU 才能擁有相當的效能。</span><span class="sxs-lookup"><span data-stu-id="d283a-159">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="d283a-160">雖然您在此架構中可以選擇只使用 CPU，但 GPU 將能提供成本/效能更好的設定檔。</span><span class="sxs-lookup"><span data-stu-id="d283a-160">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="d283a-161">我們建議使用最新 [NCv3 系列]vm-sizes-gpu 的 GPU 最佳化 VM。</span><span class="sxs-lookup"><span data-stu-id="d283a-161">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="d283a-162">並非所有區域都會將 GPU 預設為啟用。</span><span class="sxs-lookup"><span data-stu-id="d283a-162">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="d283a-163">請務必選取已啟用 GPU 的區域。</span><span class="sxs-lookup"><span data-stu-id="d283a-163">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="d283a-164">此外，針對 GPU 最佳化的 VM，訂用帳戶的預設核心配額為零。</span><span class="sxs-lookup"><span data-stu-id="d283a-164">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="d283a-165">您可以提出支援要求來提高這個配額。</span><span class="sxs-lookup"><span data-stu-id="d283a-165">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="d283a-166">請確定您訂用帳戶上的配額足以執行工作負載。</span><span class="sxs-lookup"><span data-stu-id="d283a-166">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="d283a-167">在 VM 與核心上平行處理</span><span class="sxs-lookup"><span data-stu-id="d283a-167">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="d283a-168">若以批次作業的形式來執行樣式傳輸程序，主要在 GPU 上執行的作業將必須在 VM 上平行進行處理。</span><span class="sxs-lookup"><span data-stu-id="d283a-168">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="d283a-169">這可能會有兩種方法：您可以建立較大的叢集，使用具有單一 GPU 的 VM，或建立較小的叢集，使用具有許多 GPU 的 VM。</span><span class="sxs-lookup"><span data-stu-id="d283a-169">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span> 

<span data-ttu-id="d283a-170">針對此工作負載，這兩個選項會有相當的效能。</span><span class="sxs-lookup"><span data-stu-id="d283a-170">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="d283a-171">使用較少 VM (每個 VM 有多個 GPU) 有助於減少資料移動。</span><span class="sxs-lookup"><span data-stu-id="d283a-171">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="d283a-172">不過，此功能流程上每項作業的資料量都不是非常大，因此您不會看到 Blob 儲存體有太多節流動作。</span><span class="sxs-lookup"><span data-stu-id="d283a-172">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="d283a-173">每個 Batch AI 作業的影像批次大小</span><span class="sxs-lookup"><span data-stu-id="d283a-173">Images batch size per Batch AI job</span></span>

<span data-ttu-id="d283a-174">另一個必須設定的參數是每個 Batch AI 作業要處理的影像數目。</span><span class="sxs-lookup"><span data-stu-id="d283a-174">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="d283a-175">一方面，您想要確保工作會廣泛地分配到各節點，這樣一來，如果工作失敗，您就不需要重試太多影像。</span><span class="sxs-lookup"><span data-stu-id="d283a-175">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="d283a-176">這表示有許多 Batch AI 作業，因此每個作業要處理的影像數目並不多。</span><span class="sxs-lookup"><span data-stu-id="d283a-176">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="d283a-177">但是另一方面，如果每個作業處理的影像太少，則設定/啟動時間會變得過長。</span><span class="sxs-lookup"><span data-stu-id="d283a-177">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="d283a-178">您可以將作業數目設成與叢集中的節點數目上限一樣。</span><span class="sxs-lookup"><span data-stu-id="d283a-178">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="d283a-179">如果沒有任何工作失敗，那麼這麼做的效能會最好，因為可將設定/啟動成本降到最低。</span><span class="sxs-lookup"><span data-stu-id="d283a-179">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="d283a-180">不過，如果作業失敗，則可能需要重新處理大量影像。</span><span class="sxs-lookup"><span data-stu-id="d283a-180">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="d283a-181">檔案伺服器</span><span class="sxs-lookup"><span data-stu-id="d283a-181">File servers</span></span>

<span data-ttu-id="d283a-182">使用 Batch AI 時，您可以根據您案例所需輸送量選擇多個儲存體選項。</span><span class="sxs-lookup"><span data-stu-id="d283a-182">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="d283a-183">針對輸送量需求低的工作負載，使用 Blob 儲存體 (透過 blobfuse) 應該就已足夠。</span><span class="sxs-lookup"><span data-stu-id="d283a-183">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="d283a-184">或者，Batch AI 也支援 Batch AI 檔案伺服器，此受控的單一節點 NFS 可自動裝載到叢集節點上，為作業提供集中存取的儲存體位置。</span><span class="sxs-lookup"><span data-stu-id="d283a-184">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="d283a-185">在大部分情況下，工作區中只需要一個檔案伺服器，而且您可以將訓練作業的資料分到不同目錄中。</span><span class="sxs-lookup"><span data-stu-id="d283a-185">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="d283a-186">如果單一節點 NFS 不適用於您的工作負載，Batch AI 還可支援其他儲存體選項，包括 Azure 檔案服務或自訂解決方案，例如 Gluster 或 Lustre 檔案系統。</span><span class="sxs-lookup"><span data-stu-id="d283a-186">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="d283a-187">安全性考量</span><span class="sxs-lookup"><span data-stu-id="d283a-187">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="d283a-188">限制 Azure Blob 儲存體的存取</span><span class="sxs-lookup"><span data-stu-id="d283a-188">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="d283a-189">在此參考架構中，Azure Blob 儲存體是需要保護的主要儲存體元件。</span><span class="sxs-lookup"><span data-stu-id="d283a-189">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="d283a-190">GitHub 存放庫中所示的基準部署會使用儲存體帳戶金鑰來存取 Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="d283a-190">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="d283a-191">如需進一步的控制和保護，請考慮改為使用共用存取簽章 (SAS)。</span><span class="sxs-lookup"><span data-stu-id="d283a-191">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="d283a-192">這會針對儲存體中的物件授與有限的存取權，而且無須對帳戶金鑰進行硬式編碼，或將它們儲存成純文字。</span><span class="sxs-lookup"><span data-stu-id="d283a-192">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="d283a-193">此方法特別實用，因為帳戶金鑰會以純文字形式顯示在邏輯應用程式的設計工具介面內。</span><span class="sxs-lookup"><span data-stu-id="d283a-193">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="d283a-194">使用 SAS 也有助於確保儲存體帳戶具有適當的控管，而且該存取權也只會授與應該擁有此權限的人員。</span><span class="sxs-lookup"><span data-stu-id="d283a-194">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="d283a-195">如果在具有很多敏感性資料的情況下，請確定所有儲存體金鑰都會受到保護，因為這些金鑰可授與工作負載中所有輸入和輸出資料的完整存取。</span><span class="sxs-lookup"><span data-stu-id="d283a-195">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="d283a-196">資料加密和資料移動</span><span class="sxs-lookup"><span data-stu-id="d283a-196">Data encryption and data movement</span></span>

<span data-ttu-id="d283a-197">此參考架構會使用樣式傳輸作為批次評分程序的範例。</span><span class="sxs-lookup"><span data-stu-id="d283a-197">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="d283a-198">針對資料敏感性更高的案例，儲存體中的資料應該使用待用加密。</span><span class="sxs-lookup"><span data-stu-id="d283a-198">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="d283a-199">每當資料從一個位置移至下一個位置時，應使用 SSL 來保護資料轉送。</span><span class="sxs-lookup"><span data-stu-id="d283a-199">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="d283a-200">如需詳細資料，請參閱 [Azure 儲存體安全性指南][storage-security]。</span><span class="sxs-lookup"><span data-stu-id="d283a-200">For more information, see [Azure Storage security guide][storage-security].</span></span> 

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="d283a-201">保護虛擬網路中的資料</span><span class="sxs-lookup"><span data-stu-id="d283a-201">Securing data in a virtual network</span></span>

<span data-ttu-id="d283a-202">部署 Batch AI 叢集時，您可以將叢集設定為在虛擬網路的子網路內佈建。</span><span class="sxs-lookup"><span data-stu-id="d283a-202">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="d283a-203">這可讓叢集中的計算節點與其他虛擬機器 (或甚至是內部部署網路) 安全地通訊。</span><span class="sxs-lookup"><span data-stu-id="d283a-203">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="d283a-204">您也可以使用[服務端點][service-endpoints]搭配 Blob 儲存體以允許來自虛擬網路的存取，或使用 VNET 內的單一節點 NFS 搭配 Batch AI，以確保資料一律會受到保護。</span><span class="sxs-lookup"><span data-stu-id="d283a-204">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="d283a-205">防範惡意活動</span><span class="sxs-lookup"><span data-stu-id="d283a-205">Protecting against malicious activity</span></span>

<span data-ttu-id="d283a-206">在有多個使用者的案例中，請確定敏感性資料已受到保護，以防範惡意活動。</span><span class="sxs-lookup"><span data-stu-id="d283a-206">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="d283a-207">如果有其他使用者取得此部署的存取權，因而能自訂輸入資料，請注意下列預防措施和考量：</span><span class="sxs-lookup"><span data-stu-id="d283a-207">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="d283a-208">使用 RBAC 來限制使用者只能存取所需資源。</span><span class="sxs-lookup"><span data-stu-id="d283a-208">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="d283a-209">佈建兩個不同的儲存體帳戶。</span><span class="sxs-lookup"><span data-stu-id="d283a-209">Provision two separate storage accounts.</span></span> <span data-ttu-id="d283a-210">將輸入和輸出資料儲存在第一個帳戶。</span><span class="sxs-lookup"><span data-stu-id="d283a-210">Store input and output data in the first account.</span></span> <span data-ttu-id="d283a-211">此帳戶可讓外部使用者存取。</span><span class="sxs-lookup"><span data-stu-id="d283a-211">External users can be given access to this account.</span></span> <span data-ttu-id="d283a-212">將可執行檔的指令碼及輸出的記錄檔放在其他帳戶。</span><span class="sxs-lookup"><span data-stu-id="d283a-212">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="d283a-213">外部使用者不可存取此帳戶。</span><span class="sxs-lookup"><span data-stu-id="d283a-213">External users should not have access to this account.</span></span> <span data-ttu-id="d283a-214">這可確保外部使用者無法修改任何可執行檔 (插入惡意程式碼)，並且無法存取可能保存著敏感資訊的記錄檔。</span><span class="sxs-lookup"><span data-stu-id="d283a-214">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="d283a-215">惡意使用者可以對作業佇列發動 DDOS，或將格式有誤的有害訊息插入作業佇列中，造成系統鎖住或導致清除佇列錯誤。</span><span class="sxs-lookup"><span data-stu-id="d283a-215">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span> 

## <a name="monitoring-and-logging"></a><span data-ttu-id="d283a-216">監視和記錄</span><span class="sxs-lookup"><span data-stu-id="d283a-216">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="d283a-217">監視 Batch AI 作業</span><span class="sxs-lookup"><span data-stu-id="d283a-217">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="d283a-218">當您執行工作時，務必監視進度，並確定一切運作正常。</span><span class="sxs-lookup"><span data-stu-id="d283a-218">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="d283a-219">不過，監視整個叢集上的使用中節點可能不容易。</span><span class="sxs-lookup"><span data-stu-id="d283a-219">However, it can be a challenge to monitor across a cluster of active nodes.</span></span> 

<span data-ttu-id="d283a-220">若要了解叢集的整體狀態，請移至 Azure 入口網站的 Batch AI 刀鋒視窗，以檢查叢集中的節點狀態。</span><span class="sxs-lookup"><span data-stu-id="d283a-220">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="d283a-221">如果節點狀態是非使用中或作業已失敗，則錯誤記錄會儲存在 Blob 儲存體中，您也可在 Azure 入口網站的 [作業] 刀鋒視窗中存取錯誤記錄。</span><span class="sxs-lookup"><span data-stu-id="d283a-221">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span> 

<span data-ttu-id="d283a-222">若要進一步擴充監視功能，您可以將記錄連線到 Application Insights，或執行不同處理程序來對 Batch AI 叢集和其作業的狀態進行輪詢。</span><span class="sxs-lookup"><span data-stu-id="d283a-222">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="d283a-223">Batch AI 中的記錄功能</span><span class="sxs-lookup"><span data-stu-id="d283a-223">Logging in Batch AI</span></span>

<span data-ttu-id="d283a-224">Batch AI 會自動記錄相關 Blob 儲存體帳戶的所有 stdout/stderr。</span><span class="sxs-lookup"><span data-stu-id="d283a-224">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="d283a-225">使用儲存體總管之類的儲存體瀏覽工具，可讓您更輕鬆地瀏覽記錄檔。</span><span class="sxs-lookup"><span data-stu-id="d283a-225">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span> 

<span data-ttu-id="d283a-226">此參考架構的部署步驟也會示範如何設定更簡單的記錄系統，像是讓不同作業的所有記錄都儲存到您 Blob 容器中的相同目錄，如下所示。</span><span class="sxs-lookup"><span data-stu-id="d283a-226">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span>
<span data-ttu-id="d283a-227">使用這些記錄可監視每個作業和每個影像的處理時間。</span><span class="sxs-lookup"><span data-stu-id="d283a-227">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="d283a-228">如此可讓您更了解如何進一步最佳化程序。</span><span class="sxs-lookup"><span data-stu-id="d283a-228">This will give you a better sense of how to optimize the process even further.</span></span>

![](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="d283a-229">成本考量</span><span class="sxs-lookup"><span data-stu-id="d283a-229">Cost considerations</span></span>

<span data-ttu-id="d283a-230">相較於儲存體和排程元件，此參考架構中所使用的計算資源才是影響成本的關鍵。</span><span class="sxs-lookup"><span data-stu-id="d283a-230">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="d283a-231">其中一個最大的挑戰就是，在已啟用 GPU 的機器中，有效地平行進行叢集上的工作。</span><span class="sxs-lookup"><span data-stu-id="d283a-231">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="d283a-232">Batch AI 叢集大小可根據佇列中的作業，自動地相應增加和減少。</span><span class="sxs-lookup"><span data-stu-id="d283a-232">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="d283a-233">您可以使用兩種方式中的其中一種來啟用 Batch AI 的自動調整功能。</span><span class="sxs-lookup"><span data-stu-id="d283a-233">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="d283a-234">您可以透過程式設計的方式來完成，也就是在 `.env` 檔案中進行設定 (這是[部署步驟][deployment]的一部份)，或是在建立叢集之後，直接在入口網站中變更調整公式。</span><span class="sxs-lookup"><span data-stu-id="d283a-234">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="d283a-235">對於不需要立即處理的工作，可設定自動調整公式，如此一來，預設狀態 (最小值) 就是零個節點的叢集。</span><span class="sxs-lookup"><span data-stu-id="d283a-235">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="d283a-236">使用此設定時，叢集一開始會有零個節點，並只在偵測到佇列中有作業時，才會相應增加。</span><span class="sxs-lookup"><span data-stu-id="d283a-236">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="d283a-237">如果批次評分程序一天只會發生幾次 (或更少)，則此設定可省下大量成本。</span><span class="sxs-lookup"><span data-stu-id="d283a-237">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="d283a-238">自動調整可能不適合間距太近的批次作業。</span><span class="sxs-lookup"><span data-stu-id="d283a-238">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="d283a-239">啟動及關閉叢集所花費的時間也會產生成本，因此如果批次工作負載會在前一個作業結束後的幾分鐘內啟動，那麼讓叢集在作業之間持續運作可能比較符合成本效益。</span><span class="sxs-lookup"><span data-stu-id="d283a-239">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="d283a-240">部署解決方案</span><span class="sxs-lookup"><span data-stu-id="d283a-240">Deploy the solution</span></span>

<span data-ttu-id="d283a-241">若要部署此參考架構，請遵循 [GitHub 存放庫][deployment]中所述的步驟。</span><span class="sxs-lookup"><span data-stu-id="d283a-241">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu
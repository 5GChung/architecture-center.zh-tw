---
title: API 閘道
description: 微服務中的 API 閘道
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 6483d416363e24f4084d6b856847a740bf4054d9
ms.sourcegitcommit: a8453c4bc7c870fa1a12bb3c02e3b310db87530c
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/29/2017
---
# <a name="designing-microservices-api-gateways"></a><span data-ttu-id="4bde8-103">設計微服務：API 閘道</span><span class="sxs-lookup"><span data-stu-id="4bde8-103">Designing microservices: API gateways</span></span>

<span data-ttu-id="4bde8-104">在微服務架構中，用戶端可能會與多個前端服務互動。</span><span class="sxs-lookup"><span data-stu-id="4bde8-104">In a microservices architecture, a client might interact with more than one front-end service.</span></span> <span data-ttu-id="4bde8-105">因此，用戶端要如何知道應該呼叫哪些端點？</span><span class="sxs-lookup"><span data-stu-id="4bde8-105">Given this fact, how does a client know what endpoints to call?</span></span> <span data-ttu-id="4bde8-106">引進新的服務或重構現有服務時，會發生什麼事？</span><span class="sxs-lookup"><span data-stu-id="4bde8-106">What happens when new services are introduced, or existing services are refactored?</span></span> <span data-ttu-id="4bde8-107">服務如何處理 SSL 終止、驗證和其他考量？</span><span class="sxs-lookup"><span data-stu-id="4bde8-107">How do services handle SSL termination, authentication, and other concerns?</span></span> <span data-ttu-id="4bde8-108">「API 閘道」可協助您解決這些挑戰。</span><span class="sxs-lookup"><span data-stu-id="4bde8-108">An *API gateway* can help to address these challenges.</span></span> 

![](./images/gateway.png)

## <a name="what-is-an-api-gateway"></a><span data-ttu-id="4bde8-109">什麼是 API 閘道？</span><span class="sxs-lookup"><span data-stu-id="4bde8-109">What is an API gateway?</span></span>

<span data-ttu-id="4bde8-110">API 閘道位於用戶端和服務之間。</span><span class="sxs-lookup"><span data-stu-id="4bde8-110">An API gateway sits between clients and services.</span></span> <span data-ttu-id="4bde8-111">它會作為反向 Proxy，將要求從用戶端路由傳送到服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-111">It acts as a reverse proxy, routing requests from clients to services.</span></span> <span data-ttu-id="4bde8-112">它也會執行各種跨領域工作，例如驗證、SSL 終止和速率限制。</span><span class="sxs-lookup"><span data-stu-id="4bde8-112">It may also perform various cross-cutting tasks such as authentication, SSL termination, and rate limiting.</span></span> <span data-ttu-id="4bde8-113">如果您未部署閘道，用戶端就必須將要求直接傳送給前端服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-113">If you don't deploy a gateway, clients must send requests directly to front-end services.</span></span> <span data-ttu-id="4bde8-114">不過，直接向用戶端公開服務會有一些潛在問題：</span><span class="sxs-lookup"><span data-stu-id="4bde8-114">However, there are some potential problems with exposing services directly to clients:</span></span>

- <span data-ttu-id="4bde8-115">它會導致複雜的用戶端程式碼。</span><span class="sxs-lookup"><span data-stu-id="4bde8-115">It can result in complex client code.</span></span> <span data-ttu-id="4bde8-116">用戶端必須追蹤多個端點，並以彈性的方式處理失敗。</span><span class="sxs-lookup"><span data-stu-id="4bde8-116">The client must keep track of multiple endpoints, and handle failures in a resilient way.</span></span> 
- <span data-ttu-id="4bde8-117">它會讓用戶端與後端發生結合。</span><span class="sxs-lookup"><span data-stu-id="4bde8-117">It creates coupling between the client and the backend.</span></span> <span data-ttu-id="4bde8-118">用戶端需要知道個別服務的分解方式。</span><span class="sxs-lookup"><span data-stu-id="4bde8-118">The client needs to know how the individual services are decomposed.</span></span> <span data-ttu-id="4bde8-119">這會讓您難以維護用戶端，也較不容易重構服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-119">That makes it harder to maintain the client and also harder to refactor services.</span></span>
- <span data-ttu-id="4bde8-120">單一作業可能需要呼叫多個服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-120">A single operation might require calls to multiple services.</span></span> <span data-ttu-id="4bde8-121">此動作會讓用戶端與伺服器之間有多次網路往返，而大幅增加延遲時間。</span><span class="sxs-lookup"><span data-stu-id="4bde8-121">That can result in multiple network round trips between the client and the server, adding significant latency.</span></span> 
- <span data-ttu-id="4bde8-122">每個公眾對應的服務都必須處理各種考量，例如驗證、SSL 及用戶端速率限制。</span><span class="sxs-lookup"><span data-stu-id="4bde8-122">Each public-facing service must handle concerns such as authentication, SSL, and client rate limiting.</span></span> 
- <span data-ttu-id="4bde8-123">服務必須公開用戶端熟悉的通訊協定，例如 HTTP 或 WebSocket。</span><span class="sxs-lookup"><span data-stu-id="4bde8-123">Services must expose a client-friendly protocol such as HTTP or WebSocket.</span></span> <span data-ttu-id="4bde8-124">這會限制[通訊協定](./interservice-communication.md)的選擇。</span><span class="sxs-lookup"><span data-stu-id="4bde8-124">This limits the choice of [communication protocols](./interservice-communication.md).</span></span> 
- <span data-ttu-id="4bde8-125">具有公用端點的服務是潛在的受攻擊面，因此必須予以強化。</span><span class="sxs-lookup"><span data-stu-id="4bde8-125">Services with public endpoints are a potential attack surface, and must be hardened.</span></span>

<span data-ttu-id="4bde8-126">閘道可透過讓用戶端與服務分離來協助解決這些問題。</span><span class="sxs-lookup"><span data-stu-id="4bde8-126">A gateway helps to address these issues by decoupling clients from services.</span></span> <span data-ttu-id="4bde8-127">閘道可以執行幾種不同的功能，您不一定需要全部使用。</span><span class="sxs-lookup"><span data-stu-id="4bde8-127">Gateways can perform a number of different functions, and you may not need all of them.</span></span> <span data-ttu-id="4bde8-128">功能可分為下列設計模式：</span><span class="sxs-lookup"><span data-stu-id="4bde8-128">The functions can be grouped into the following design patterns:</span></span>

<span data-ttu-id="4bde8-129">[閘道路由](../patterns/gateway-routing.md)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-129">[Gateway Routing](../patterns/gateway-routing.md).</span></span> <span data-ttu-id="4bde8-130">將閘道作為反向 Proxy，以使用第 7 層路由將要求路由傳送至一或多個後端服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-130">Use the gateway as a reverse proxy to route requests to one or more backend services, using layer 7 routing.</span></span> <span data-ttu-id="4bde8-131">閘道會為用戶端提供單一端點，並有助於讓用戶端與服務分離。</span><span class="sxs-lookup"><span data-stu-id="4bde8-131">The gateway provides a single endpoint for clients, and helps to decouple clients from services.</span></span> 

<span data-ttu-id="4bde8-132">[閘道彙總](../patterns/gateway-aggregation.md)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-132">[Gateway Aggregation](../patterns/gateway-aggregation.md).</span></span> <span data-ttu-id="4bde8-133">您可以使用閘道將多個個別要求彙總為單一要求。</span><span class="sxs-lookup"><span data-stu-id="4bde8-133">Use the gateway to aggregate multiple individual requests into a single request.</span></span> <span data-ttu-id="4bde8-134">當單一作業需要呼叫多個後端服務時，便適用此模式。</span><span class="sxs-lookup"><span data-stu-id="4bde8-134">This pattern applies when a single operation requires calls to multiple backend services.</span></span> <span data-ttu-id="4bde8-135">用戶端會將一個要求傳送至閘道。</span><span class="sxs-lookup"><span data-stu-id="4bde8-135">The client sends one request to the gateway.</span></span> <span data-ttu-id="4bde8-136">閘道會將要求分派至各種後端系統，然後彙總結果並傳回給用戶端。</span><span class="sxs-lookup"><span data-stu-id="4bde8-136">The gateway dispatches requests to the various backend services, and then aggregates the results and sends them back to the client.</span></span> <span data-ttu-id="4bde8-137">這有助於減少用戶端與後端之間的通訊頻率。</span><span class="sxs-lookup"><span data-stu-id="4bde8-137">This helps to reduce chattiness between the client and the backend.</span></span> 

<span data-ttu-id="4bde8-138">[閘道卸載](../patterns/gateway-offloading.md)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-138">[Gateway Offloading](../patterns/gateway-offloading.md).</span></span> <span data-ttu-id="4bde8-139">您可以使用閘道將功能從個別服務卸載到閘道 (特別是在有跨領域考量時)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-139">Use the gateway to offload functionality from individual services to the gateway, particularly cross-cutting concerns.</span></span> <span data-ttu-id="4bde8-140">它可用來將這些功能合併到一個地方，而不是讓每項服務負責實作這些功能。</span><span class="sxs-lookup"><span data-stu-id="4bde8-140">It can be useful to consolidate these functions into one place, rather than making every service responsible for implementing them.</span></span> <span data-ttu-id="4bde8-141">對於需要專門技術才能正確實作的功能 (例如驗證和授權)，尤其應該這麼做。</span><span class="sxs-lookup"><span data-stu-id="4bde8-141">This is particularly true for features that requires specialized skills to implement correctly, such as authentication and authorization.</span></span> 

<span data-ttu-id="4bde8-142">以下是可以卸載到閘道的一些功能範例：</span><span class="sxs-lookup"><span data-stu-id="4bde8-142">Here are some examples of functionality that could be offloaded to a gateway:</span></span>

- <span data-ttu-id="4bde8-143">SSL 終止</span><span class="sxs-lookup"><span data-stu-id="4bde8-143">SSL termination</span></span>
- <span data-ttu-id="4bde8-144">驗證</span><span class="sxs-lookup"><span data-stu-id="4bde8-144">Authentication</span></span>
- <span data-ttu-id="4bde8-145">IP 白名單</span><span class="sxs-lookup"><span data-stu-id="4bde8-145">IP whitelisting</span></span>
- <span data-ttu-id="4bde8-146">用戶端速率限制 (節流)</span><span class="sxs-lookup"><span data-stu-id="4bde8-146">Client rate limiting (throttling)</span></span>
- <span data-ttu-id="4bde8-147">記錄和監視</span><span class="sxs-lookup"><span data-stu-id="4bde8-147">Logging and monitoring</span></span>
- <span data-ttu-id="4bde8-148">回應快取</span><span class="sxs-lookup"><span data-stu-id="4bde8-148">Response caching</span></span>
- <span data-ttu-id="4bde8-149">Web 應用程式防火牆</span><span class="sxs-lookup"><span data-stu-id="4bde8-149">Web application firewall</span></span>
- <span data-ttu-id="4bde8-150">GZip 壓縮</span><span class="sxs-lookup"><span data-stu-id="4bde8-150">GZIP compression</span></span>
- <span data-ttu-id="4bde8-151">提供靜態內容</span><span class="sxs-lookup"><span data-stu-id="4bde8-151">Servicing static content</span></span>

## <a name="choosing-a-gateway-technology"></a><span data-ttu-id="4bde8-152">選擇閘道技術</span><span class="sxs-lookup"><span data-stu-id="4bde8-152">Choosing a gateway technology</span></span>

<span data-ttu-id="4bde8-153">以下是在應用程式中實作 API 閘道的一些選項。</span><span class="sxs-lookup"><span data-stu-id="4bde8-153">Here are some options for implementing an API gateway in your application.</span></span>

- <span data-ttu-id="4bde8-154">**反向 Proxy 伺服器**。</span><span class="sxs-lookup"><span data-stu-id="4bde8-154">**Reverse proxy server**.</span></span> <span data-ttu-id="4bde8-155">Nginx 和 HAProxy 等熱門的反向 Proxy 伺服器可支援負載平衡、SSL 和第 7 層路由等功能。</span><span class="sxs-lookup"><span data-stu-id="4bde8-155">Nginx and HAProxy are popular reverse proxy servers that support features such as load balancing, SSL, and layer 7 routing.</span></span> <span data-ttu-id="4bde8-156">兩者都是免費的開放原始碼產品，而其付費版則會提供額外的功能和支援選項。</span><span class="sxs-lookup"><span data-stu-id="4bde8-156">They are both free, open-source products, with paid editions that provide additional features and support options.</span></span> <span data-ttu-id="4bde8-157">Nginx 及 HAProxy 都是成熟的產品，並具有豐富的功能集和高效能。</span><span class="sxs-lookup"><span data-stu-id="4bde8-157">Nginx and HAProxy are both mature products with rich feature sets and high performance.</span></span> <span data-ttu-id="4bde8-158">您可以透過第三方模組或在 Lua 中撰寫自訂指令碼來對兩者進行擴充。</span><span class="sxs-lookup"><span data-stu-id="4bde8-158">You can extend them with third-party modules or by writing custom scripts in Lua.</span></span> <span data-ttu-id="4bde8-159">Nginx 也支援稱為 NginScript 的 JavaScript 型指令碼模組。</span><span class="sxs-lookup"><span data-stu-id="4bde8-159">Nginx also supports a JavaScript-based scripting module called NginScript.</span></span>

- <span data-ttu-id="4bde8-160">**服務網格輸入控制器**。</span><span class="sxs-lookup"><span data-stu-id="4bde8-160">**Service mesh ingress controller**.</span></span> <span data-ttu-id="4bde8-161">如果您要使用 linkerd 或 Istio 等服務網格，請考慮使用輸入控制器針對該服務網格所提供的功能。</span><span class="sxs-lookup"><span data-stu-id="4bde8-161">If you are using a service mesh such as linkerd or Istio, consider the features that are provided by the ingress controller for that service mesh.</span></span> <span data-ttu-id="4bde8-162">例如，Istio 輸入控制器可支援第 7 層路由、HTTP 重新導向、重試和其他功能。</span><span class="sxs-lookup"><span data-stu-id="4bde8-162">For example, the Istio ingress controller supports layer 7 routing, HTTP redirects, retries, and other features.</span></span> 

- <span data-ttu-id="4bde8-163">[Azure 應用程式閘道](/azure/application-gateway/)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-163">[Azure Application Gateway](/azure/application-gateway/).</span></span> <span data-ttu-id="4bde8-164">應用程式閘道是受控的負載平衡服務，可執行第 7 層路由和 SSL 終止。</span><span class="sxs-lookup"><span data-stu-id="4bde8-164">Application Gateway is a managed load balancing service that can perform layer-7 routing and SSL termination.</span></span> <span data-ttu-id="4bde8-165">此外，也會提供 Web 應用程式防火牆 (WAF)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-165">It also provides a web application firewall (WAF).</span></span>

- <span data-ttu-id="4bde8-166">[Azure API 管理](/azure/api-management/)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-166">[Azure API Management](/azure/api-management/).</span></span> <span data-ttu-id="4bde8-167">Azure API 管理是周全的解決方案，可將 API 發佈給外部及內部客戶。</span><span class="sxs-lookup"><span data-stu-id="4bde8-167">API Management is a turnkey solution for publishing APIs to external and internal customers.</span></span> <span data-ttu-id="4bde8-168">它提供的功能可用於管理公眾對應 API，包括速率限制、IP 白名單建立，以及使用 Azure Active Directory 或其他識別提供者來進行的驗證。</span><span class="sxs-lookup"><span data-stu-id="4bde8-168">It provides features that are useful for managing a public-facing API, including rate limiting, IP white listing, and authentication using Azure Active Directory or other identity providers.</span></span> <span data-ttu-id="4bde8-169">API 管理不會執行任何負載平衡作業，因此應該與負載平衡器搭配使用，例如應用程式閘道或反向 Proxy。</span><span class="sxs-lookup"><span data-stu-id="4bde8-169">API Management doesn't perform any load balancing, so it should be used in conjunction with a load balancer such as Application Gateway or a reverse proxy.</span></span>

<span data-ttu-id="4bde8-170">在選擇閘道技術時，請考慮下列因素：</span><span class="sxs-lookup"><span data-stu-id="4bde8-170">When choosing a gateway technology, consider the following:</span></span>

<span data-ttu-id="4bde8-171">**功能**。</span><span class="sxs-lookup"><span data-stu-id="4bde8-171">**Features**.</span></span> <span data-ttu-id="4bde8-172">以上列出的選項皆支援第 7 層路由，但對於其他功能的支援則各不相同。</span><span class="sxs-lookup"><span data-stu-id="4bde8-172">The options listed above all support layer 7 routing, but support for other features will vary.</span></span> <span data-ttu-id="4bde8-173">根據您所需要的功能，您可能會部署多個閘道。</span><span class="sxs-lookup"><span data-stu-id="4bde8-173">Depending on the features that you need, you might deploy more than one gateway.</span></span> 

<span data-ttu-id="4bde8-174">**部署**。</span><span class="sxs-lookup"><span data-stu-id="4bde8-174">**Deployment**.</span></span> <span data-ttu-id="4bde8-175">Azure 應用程式閘道與 API 管理是受控服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-175">Azure Application Gateway and API Management are managed services.</span></span> <span data-ttu-id="4bde8-176">Nginx 及 HAProxy 一般會在叢集內的容器中執行，但也可部署到叢集外的專用 VM。</span><span class="sxs-lookup"><span data-stu-id="4bde8-176">Nginx and HAProxy will typically run in containers inside the cluster, but can also be deployed to dedicated VMs outside of the cluster.</span></span> <span data-ttu-id="4bde8-177">這麼做可將閘道與其他工作負載隔離開來，但會產生較高的管理負荷。</span><span class="sxs-lookup"><span data-stu-id="4bde8-177">This isolates the gateway from the rest of the workload, but incurs higher management overhead.</span></span>

<span data-ttu-id="4bde8-178">**管理**。</span><span class="sxs-lookup"><span data-stu-id="4bde8-178">**Management**.</span></span> <span data-ttu-id="4bde8-179">當服務經過更新或有新增的服務時，您可能需要更新閘道路由規則。</span><span class="sxs-lookup"><span data-stu-id="4bde8-179">When services are updated or new services are added, the gateway routing rules may need to be updated.</span></span> <span data-ttu-id="4bde8-180">請考慮該如何管理此程序。</span><span class="sxs-lookup"><span data-stu-id="4bde8-180">Consider how this process will be managed.</span></span> <span data-ttu-id="4bde8-181">管理 SSL 憑證、IP 白名單和其他組態部分也會有類似考量。</span><span class="sxs-lookup"><span data-stu-id="4bde8-181">Similar considerations apply to managing SSL certificates, IP whitelists, and other aspects of configuration.</span></span>

## <a name="deployment-considerations"></a><span data-ttu-id="4bde8-182">部署考量</span><span class="sxs-lookup"><span data-stu-id="4bde8-182">Deployment considerations</span></span>

### <a name="deploying-nginx-or-haproxy-to-kubernetes"></a><span data-ttu-id="4bde8-183">將 Nginx 或 HAProxy 部署到 Kubernetes</span><span class="sxs-lookup"><span data-stu-id="4bde8-183">Deploying Nginx or HAProxy to Kubernetes</span></span>

<span data-ttu-id="4bde8-184">您可以將 Nginx 或 HAProxy 部署至 Kubernetes 來作為 [ReplicaSet](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/) 或 [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/)，以指定 Nginx 或 HAProxy 容器映像。</span><span class="sxs-lookup"><span data-stu-id="4bde8-184">You can deploy Nginx or HAProxy to Kubernetes as a [ReplicaSet](https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/) or [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) that specifies the Nginx or HAProxy container image.</span></span> <span data-ttu-id="4bde8-185">使用 ConfigMap 來儲存 Proxy 的組態檔，並將 ConfigMap 掛接為磁碟區。</span><span class="sxs-lookup"><span data-stu-id="4bde8-185">Use a ConfigMap to store the configuration file for the proxy, and mount the ConfigMap as a volume.</span></span> <span data-ttu-id="4bde8-186">建立 LoadBalancer 類型的服務，以透過 Azure Load Balancer 公開閘道。</span><span class="sxs-lookup"><span data-stu-id="4bde8-186">Create a service of type LoadBalancer to expose the gateway through an Azure Load Balancer.</span></span> 

<!-- - Configure a readiness probe that serves a static file from the gateway (rather than routing to another service). -->

<span data-ttu-id="4bde8-187">另一種方法是建立輸入控制器。</span><span class="sxs-lookup"><span data-stu-id="4bde8-187">An alternative is to create an Ingress Controller.</span></span> <span data-ttu-id="4bde8-188">輸入控制器是一種 Kubernetes 資源，可部署負載平衡器或反向 Proxy 伺服器。</span><span class="sxs-lookup"><span data-stu-id="4bde8-188">An Ingress Controller is a Kubernetes resource that deploys a load balancer or reverse proxy server.</span></span> <span data-ttu-id="4bde8-189">存在的實作有好幾種，包括 Nginx 及 HAProxy。</span><span class="sxs-lookup"><span data-stu-id="4bde8-189">Several implementations exist, including Nginx and HAProxy.</span></span> <span data-ttu-id="4bde8-190">另有稱為輸入的資源會定義輸入控制器的設定，例如路由規則和 TLS 憑證。</span><span class="sxs-lookup"><span data-stu-id="4bde8-190">A separate resource called an Ingress defines settings for the Ingress Controller, such as routing rules and TLS certificates.</span></span> <span data-ttu-id="4bde8-191">這樣一來，您就不需要管理專屬於特定 Proxy 伺服器技術的複雜組態檔。</span><span class="sxs-lookup"><span data-stu-id="4bde8-191">That way, you don't need to manage complex configuration files that are specific to a particular proxy server technology.</span></span> <span data-ttu-id="4bde8-192">在本文撰寫當下，輸入控制器仍是 Kubernetes 的搶鮮版 (Beta) 功能，而且該功能會持續改進。</span><span class="sxs-lookup"><span data-stu-id="4bde8-192">Ingress Controllers are still a beta feature of Kubernetes at the time of this writing, and the feature will continue to evolve.</span></span>

<span data-ttu-id="4bde8-193">閘道是系統中的潛在瓶頸或單一失敗點，因此請一律部署至少兩個複本以獲得高可用性。</span><span class="sxs-lookup"><span data-stu-id="4bde8-193">The gateway is a potential bottleneck or single point of failure in the system, so always deploy at least two replicas for high availability.</span></span> <span data-ttu-id="4bde8-194">您可以視負載而定將複本進一步相應放大。</span><span class="sxs-lookup"><span data-stu-id="4bde8-194">You may need to scale out the replicas further, depending on the load.</span></span> 

<span data-ttu-id="4bde8-195">也請考慮在叢集中的一組專用節點上執行閘道。</span><span class="sxs-lookup"><span data-stu-id="4bde8-195">Also consider running the gateway on a dedicated set of nodes in the cluster.</span></span> <span data-ttu-id="4bde8-196">此方法的好處包括：</span><span class="sxs-lookup"><span data-stu-id="4bde8-196">Benefits to this approach include:</span></span>

- <span data-ttu-id="4bde8-197">隔離。</span><span class="sxs-lookup"><span data-stu-id="4bde8-197">Isolation.</span></span> <span data-ttu-id="4bde8-198">所有輸入流量會流向一組固定節點，因而可以與後端服務隔開。</span><span class="sxs-lookup"><span data-stu-id="4bde8-198">All inbound traffic goes to a fixed set of nodes, which can be isolated from backend services.</span></span>

- <span data-ttu-id="4bde8-199">穩定的設定。</span><span class="sxs-lookup"><span data-stu-id="4bde8-199">Stable configuration.</span></span> <span data-ttu-id="4bde8-200">如果閘道的設定不正確，整個應用程式可能會變得無法使用。</span><span class="sxs-lookup"><span data-stu-id="4bde8-200">If the gateway is misconfigured, the entire application may become unavailable.</span></span> 

- <span data-ttu-id="4bde8-201">效能。</span><span class="sxs-lookup"><span data-stu-id="4bde8-201">Performance.</span></span> <span data-ttu-id="4bde8-202">基於效能的考量，建議您對閘道使用特定的 VM 設定。</span><span class="sxs-lookup"><span data-stu-id="4bde8-202">You may want to use a specific VM configuration for the gateway for performance reasons.</span></span>

<!-- - Load balancing. You can configure the external load balancer so that requests always go to a gateway node. That can save a network hop, which would otherwise happen whenever a request lands on a node that isn't running a gateway pod. This consideration applies mainly to large clusters, where the gateway runs on a relatively small fraction of the total nodes. In Azure Container Service (ACS), this approach currently requires [ACS Engine](https://github.com/Azure/acs-engine)) which allows you to create multiple agent pools. Then you can deploy the gateway as a DaemonSet to the front-end pool. -->

### <a name="azure-application-gateway"></a><span data-ttu-id="4bde8-203">Azure 應用程式閘道</span><span class="sxs-lookup"><span data-stu-id="4bde8-203">Azure Application Gateway</span></span>

<span data-ttu-id="4bde8-204">若要將應用程式閘道連線至 Azure 中的 Kubernetes 叢集：</span><span class="sxs-lookup"><span data-stu-id="4bde8-204">To connect Application Gateway to a Kubernetes cluster in Azure:</span></span>

1. <span data-ttu-id="4bde8-205">在叢集 VNet 中建立空白的子網路。</span><span class="sxs-lookup"><span data-stu-id="4bde8-205">Create an empty subnet in the cluster VNet.</span></span>
2. <span data-ttu-id="4bde8-206">部署應用程式閘道。</span><span class="sxs-lookup"><span data-stu-id="4bde8-206">Deploy Application Gateway.</span></span>
3. <span data-ttu-id="4bde8-207">建立類型為 [NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport) 的 Kubernetes 服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-207">Create a Kubernetes service with type=[NodePort](https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport).</span></span> <span data-ttu-id="4bde8-208">這會在每個節點上公開服務，以便您可從叢集外部連線到該服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-208">This exposes the service on each node so that it can be reached from outside the cluster.</span></span> <span data-ttu-id="4bde8-209">它不會建立負載平衡器。</span><span class="sxs-lookup"><span data-stu-id="4bde8-209">It does not create a load balancer.</span></span>
5. <span data-ttu-id="4bde8-210">取得為服務指派的連接埠號碼。</span><span class="sxs-lookup"><span data-stu-id="4bde8-210">Get the assigned port number for the service.</span></span>
6. <span data-ttu-id="4bde8-211">新增符合以下條件的應用程式閘道規則：</span><span class="sxs-lookup"><span data-stu-id="4bde8-211">Add an Application Gateway rule where:</span></span>
    - <span data-ttu-id="4bde8-212">後端集區包含代理程式 VM。</span><span class="sxs-lookup"><span data-stu-id="4bde8-212">The backend pool contains the agent VMs.</span></span>
    - <span data-ttu-id="4bde8-213">HTTP 設定會指定服務連接埠號碼。</span><span class="sxs-lookup"><span data-stu-id="4bde8-213">The HTTP setting specifies the service port number.</span></span>
    - <span data-ttu-id="4bde8-214">閘道接聽程式會接聽連接埠 80/443</span><span class="sxs-lookup"><span data-stu-id="4bde8-214">The gateway listener listens on ports 80/443</span></span>
    
<span data-ttu-id="4bde8-215">將執行個體計數設定為 2 以上，以便提供高可用性。</span><span class="sxs-lookup"><span data-stu-id="4bde8-215">Set the instance count to 2 or more for high availability.</span></span>

### <a name="azure-api-management"></a><span data-ttu-id="4bde8-216">Azure API 管理</span><span class="sxs-lookup"><span data-stu-id="4bde8-216">Azure API Management</span></span> 

<span data-ttu-id="4bde8-217">若要將 API 管理連線至 Azure 中的 Kubernetes 叢集：</span><span class="sxs-lookup"><span data-stu-id="4bde8-217">To connect API Management to a Kubernetes cluster in Azure:</span></span>

1. <span data-ttu-id="4bde8-218">在叢集 VNet 中建立空白的子網路。</span><span class="sxs-lookup"><span data-stu-id="4bde8-218">Create an empty subnet in the cluster VNet.</span></span>
2. <span data-ttu-id="4bde8-219">將 API 管理部署到該子網路。</span><span class="sxs-lookup"><span data-stu-id="4bde8-219">Deploy API Management to that subnet.</span></span>
3. <span data-ttu-id="4bde8-220">建立類型為 LoadBalancer 的 Kubernetes 服務。</span><span class="sxs-lookup"><span data-stu-id="4bde8-220">Create a Kubernetes service of type LoadBalancer.</span></span> <span data-ttu-id="4bde8-221">使用[內部負載平衡器](https://kubernetes.io/docs/concepts/services-networking/service/#internal-load-balancer)註釋來建立內部負載平衡器，而不是根據預設建立網際網路對向負載平衡器。</span><span class="sxs-lookup"><span data-stu-id="4bde8-221">Use the [internal load balancer](https://kubernetes.io/docs/concepts/services-networking/service/#internal-load-balancer) annotation to create an internal load balancer, instead of an Internet-facing load balancer, which is the default.</span></span>
4. <span data-ttu-id="4bde8-222">使用 kubectl 或 Azure CLI 找到內部負載平衡器的私人 IP。</span><span class="sxs-lookup"><span data-stu-id="4bde8-222">Find the private IP of the internal load balancer, using kubectl or the Azure CLI.</span></span>
5. <span data-ttu-id="4bde8-223">使用 API 管理來建立會導向到負載平衡器私人 IP 位址的 API。</span><span class="sxs-lookup"><span data-stu-id="4bde8-223">Use API Management to create an API that directs to the private IP address of the load balancer.</span></span>

<span data-ttu-id="4bde8-224">請考慮將 API 管理與反向 Proxy (Nginx、HAProxy 或 Azure 應用程式閘道) 合併。</span><span class="sxs-lookup"><span data-stu-id="4bde8-224">Consider combining API Management with a reverse proxy, whether Nginx, HAProxy, or Azure Application Gateway.</span></span> <span data-ttu-id="4bde8-225">如需搭配使用 API 管理與應用程式閘道的相關資訊，請參閱[整合內部 VNET 中的 API 管理與應用程式閘道](/azure/api-management/api-management-howto-integrate-internal-vnet-appgateway)。</span><span class="sxs-lookup"><span data-stu-id="4bde8-225">For information about using API Management with Application Gateway, see [Integrate API Management in an internal VNET with Application Gateway](/azure/api-management/api-management-howto-integrate-internal-vnet-appgateway).</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="4bde8-226">記錄和監視</span><span class="sxs-lookup"><span data-stu-id="4bde8-226">Logging and monitoring</span></span>](./logging-monitoring.md)

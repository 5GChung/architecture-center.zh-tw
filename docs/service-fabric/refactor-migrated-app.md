---
title: "重構由 Azure 雲端服務移轉的 Azure Service Fabric 應用程式"
description: "如何重構由 Azure 雲端服務移轉的現有 Azure Service Fabric 應用程式"
author: petertay
ms.date: 01/30/2018
ms.openlocfilehash: 4889fae8f157b0f1205e7d8223f125974be59ba9
ms.sourcegitcommit: 2c9a8edf3e44360d7c02e626ea8ac3b03fdfadba
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 02/03/2018
---
# <a name="refactor-an-azure-service-fabric-application-migrated-from-azure-cloud-services"></a><span data-ttu-id="6fd83-103">重構由 Azure 雲端服務移轉的 Azure Service Fabric 應用程式</span><span class="sxs-lookup"><span data-stu-id="6fd83-103">Refactor an Azure Service Fabric Application migrated from Azure Cloud Services</span></span>

<span data-ttu-id="6fd83-104">[![GitHub](../_images/github.png) 程式碼範例][sample-code]</span><span class="sxs-lookup"><span data-stu-id="6fd83-104">[![GitHub](../_images/github.png) Sample code][sample-code]</span></span>

<span data-ttu-id="6fd83-105">本文說明將現有 Azure Service Fabric 應用程式重構為更細微的架構。</span><span class="sxs-lookup"><span data-stu-id="6fd83-105">This article describes refactoring an existing Azure Service Fabric application to a more granular architecture.</span></span> <span data-ttu-id="6fd83-106">本文著重在重構 Service Fabric 應用程式的設計、封裝、效能和部署考量。</span><span class="sxs-lookup"><span data-stu-id="6fd83-106">This article focuses on the design, packaging, performance, and deployment considerations of the refactored Service Fabric application.</span></span>

## <a name="scenario"></a><span data-ttu-id="6fd83-107">案例</span><span class="sxs-lookup"><span data-stu-id="6fd83-107">Scenario</span></span>

<span data-ttu-id="6fd83-108">如先前的文章[將 Azure 雲端服務應用程式移轉至 Azure Service Fabric][migrate-from-cloud-services] 中所討論的，模式和實務小組在 2012 年撰寫的書籍中，記載了在 Azure 中設計和實作雲端服務應用程式的程序。</span><span class="sxs-lookup"><span data-stu-id="6fd83-108">As discussed in the previous article, [Migrating an Azure Cloud Services application to Azure Service Fabric][migrate-from-cloud-services], the patterns & practices team authored a book in 2012 that documented the process for designing and implementing a Cloud Services application in Azure.</span></span> <span data-ttu-id="6fd83-109">該書籍描述名為 Tailspin 的虛構公司，想要建立名為 **Surveys** 的雲端服務應用程式。</span><span class="sxs-lookup"><span data-stu-id="6fd83-109">The book describes a fictitious company named Tailspin that wants to create a Cloud Services application named **Surveys**.</span></span> <span data-ttu-id="6fd83-110">Surveys 應用程式可以讓使用者建立及發行問卷，讓大眾回答。</span><span class="sxs-lookup"><span data-stu-id="6fd83-110">The Surveys application allows users to create and publish surveys that can be answered by the public.</span></span> <span data-ttu-id="6fd83-111">下圖顯示此版本 Surveys 應用程式的架構：</span><span class="sxs-lookup"><span data-stu-id="6fd83-111">The following diagram shows the architecture of this version of the Surveys application:</span></span>

![](./images/tailspin01.png)

<span data-ttu-id="6fd83-112">**Tailspin.Web** Web 角色可裝載 ASP.NET MVC 網站，供 Tailspin 客戶用來：</span><span class="sxs-lookup"><span data-stu-id="6fd83-112">The **Tailspin.Web** web role hosts an ASP.NET MVC site that Tailspin customers use to:</span></span>
* <span data-ttu-id="6fd83-113">註冊 Surveys 應用程式，</span><span class="sxs-lookup"><span data-stu-id="6fd83-113">sign up for the Surveys application,</span></span>
* <span data-ttu-id="6fd83-114">建立或刪除單一問卷，</span><span class="sxs-lookup"><span data-stu-id="6fd83-114">create or delete a single survey,</span></span>
* <span data-ttu-id="6fd83-115">檢視單一問卷的結果，</span><span class="sxs-lookup"><span data-stu-id="6fd83-115">view results for a single survey,</span></span>
* <span data-ttu-id="6fd83-116">要求將該問卷結果匯出到 SQL，以及</span><span class="sxs-lookup"><span data-stu-id="6fd83-116">request that survey results be exported to SQL, and</span></span>
* <span data-ttu-id="6fd83-117">檢視彙總的問卷結果和分析。</span><span class="sxs-lookup"><span data-stu-id="6fd83-117">view aggregated survey results and analysis.</span></span>

<span data-ttu-id="6fd83-118">**Tailspin.Web.Survey.Public** Web 角色也可以裝載 ASP.NET MVC 網站，讓大眾造訪以填寫問卷。</span><span class="sxs-lookup"><span data-stu-id="6fd83-118">The **Tailspin.Web.Survey.Public** web role also hosts an ASP.NET MVC site that the public visits to fill out the surveys.</span></span> <span data-ttu-id="6fd83-119">這些回應會放在要儲存的佇列中。</span><span class="sxs-lookup"><span data-stu-id="6fd83-119">These responses are put in a queue to be saved.</span></span>

<span data-ttu-id="6fd83-120">**Tailspin.Workers.Survey** 背景工作角色會從多個佇列中挑選要求來執行幕後處理。</span><span class="sxs-lookup"><span data-stu-id="6fd83-120">The **Tailspin.Workers.Survey** worker role performs background processing by picking up requests from multiple queues.</span></span>

<span data-ttu-id="6fd83-121">然後模式和實務小組會建立新專案，以將這個應用程式移轉到 Azure Service Fabric。</span><span class="sxs-lookup"><span data-stu-id="6fd83-121">The patterns & practices team then created a new project to port this application to Azure Service Fabric.</span></span> <span data-ttu-id="6fd83-122">此專案的目標是只進行必要的程式碼變更，讓應用程式在 Azure Service Fabric 叢集中執行。</span><span class="sxs-lookup"><span data-stu-id="6fd83-122">The goal of this project was to make only the necessary code changes to get the application running in an Azure Service Fabric cluster.</span></span> <span data-ttu-id="6fd83-123">如此一來，原始的 Web 角色和背景工作角色就不會分解成更細微的架構。</span><span class="sxs-lookup"><span data-stu-id="6fd83-123">As a result, the original web and worker roles were not decomposed into a more granular architecture.</span></span> <span data-ttu-id="6fd83-124">產生的架構與應用程式的雲端服務版本非常類似：</span><span class="sxs-lookup"><span data-stu-id="6fd83-124">The resulting architecture is very similar to the Cloud Service version of the application:</span></span>

![](./images/tailspin02.png)

<span data-ttu-id="6fd83-125">**Tailspin.Web** 服務是從原始的 Tailspin.Web Web 角色移轉。</span><span class="sxs-lookup"><span data-stu-id="6fd83-125">The **Tailspin.Web** service is ported from the original *Tailspin.Web* web role.</span></span>

<span data-ttu-id="6fd83-126">**Tailspin.Web.Survey.Public** 服務是從原始的 Tailspin.Web.Survey.Public Web 角色移轉。</span><span class="sxs-lookup"><span data-stu-id="6fd83-126">The **Tailspin.Web.Survey.Public** service is ported from the original *Tailspin.Web.Survey.Public* web role.</span></span>

<span data-ttu-id="6fd83-127">**Tailspin.AnswerAnalysisService** 服務是從原始的 Tailspin.Workers.Survey 背景工作角色移轉。</span><span class="sxs-lookup"><span data-stu-id="6fd83-127">The **Tailspin.AnswerAnalysisService** service is ported from the original *Tailspin.Workers.Survey* worker role.</span></span>

> [!NOTE] 
> <span data-ttu-id="6fd83-128">對每個 Web 角色和背景工作角色進行最少的程式碼變更時，**Tailspin.Web** 和 **Tailspin.Web.Survey.Public** 會修改以自我裝載 [Kestrel] 網頁伺服器。</span><span class="sxs-lookup"><span data-stu-id="6fd83-128">While minimal code changes were made to each of the web and worker roles, **Tailspin.Web** and **Tailspin.Web.Survey.Public** were modified to self-host a [Kestrel] web server.</span></span> <span data-ttu-id="6fd83-129">舊版的 Surveys 應用程式是 ASP.Net 應用程式，它是使用 Internet Information Services (IIS) 所裝載的，但是無法在 Service Fabric 中執行 IIS 作為服務。</span><span class="sxs-lookup"><span data-stu-id="6fd83-129">The earlier Surveys application is an ASP.Net application that was hosted using Interet Information Services (IIS), but it is not possible to run IIS as a service in Service Fabric.</span></span> <span data-ttu-id="6fd83-130">因此，任何網頁伺服器必須能夠自我裝載，例如 [Kestrel]。</span><span class="sxs-lookup"><span data-stu-id="6fd83-130">Therefore, any web server must be capable of being self-hosted, such as [Kestrel].</span></span> <span data-ttu-id="6fd83-131">在某些情況下可能可以在 Service Fabric 於容器中執行 IIS。</span><span class="sxs-lookup"><span data-stu-id="6fd83-131">It is possible to run IIS in a container in Service Fabric in some situations.</span></span> <span data-ttu-id="6fd83-132">如需詳細資訊，請參閱[使用容器的案例][container-scenarios]。</span><span class="sxs-lookup"><span data-stu-id="6fd83-132">See [scenarios for using containers][container-scenarios] for more information.</span></span>  

<span data-ttu-id="6fd83-133">現在，Tailspin 將 Surveys 應用程式重構成更細微的架構。</span><span class="sxs-lookup"><span data-stu-id="6fd83-133">Now, Tailspin is refactoring the Surveys application to a more granular architecture.</span></span> <span data-ttu-id="6fd83-134">Tailspin 重構的動機是讓開發、建置及部署 Surveys 應用程式更加容易。</span><span class="sxs-lookup"><span data-stu-id="6fd83-134">Tailspin's motivation for refactoring is to make it easier to develop, build, and deploy the Surveys application.</span></span> <span data-ttu-id="6fd83-135">透過將現有 Web 角色和背景工作角色分解成更細微的架構，Tailspin 想要移除這些角色之間現有的緊密結合通訊和資料相依性。</span><span class="sxs-lookup"><span data-stu-id="6fd83-135">By decomposing the existing web and worker roles to a more granular architecture, Tailspin wants to remove the existing tightly coupled communication and data dependencies between these roles.</span></span>

<span data-ttu-id="6fd83-136">Tailspin 看見了將 Surveys 應用程式重構成更細微的架構之其他優點：</span><span class="sxs-lookup"><span data-stu-id="6fd83-136">Tailspin sees other benefits in moving the Surveys application to a more granular architecture:</span></span>
* <span data-ttu-id="6fd83-137">每個服務可以封裝到獨立專案，其範圍小到足以由小型小組來管理。</span><span class="sxs-lookup"><span data-stu-id="6fd83-137">Each service can be packaged into independent projects with a scope small enough to be managed by a small team.</span></span>
* <span data-ttu-id="6fd83-138">每個服務都可以獨立設定版本和部署。</span><span class="sxs-lookup"><span data-stu-id="6fd83-138">Each service can be independently versioned and deployed.</span></span>
* <span data-ttu-id="6fd83-139">每個服務可以使用該服務的最佳技術來實作。</span><span class="sxs-lookup"><span data-stu-id="6fd83-139">Each service can be implemented using the best technology for that service.</span></span> <span data-ttu-id="6fd83-140">例如，Service Fabric 叢集可以包含使用不同版本的 .Net Frameworks、Java 或其他語言 (例如 C 或 C++) 建置之服務。</span><span class="sxs-lookup"><span data-stu-id="6fd83-140">For example, a service fabric cluster can include services built using different versions of the .Net Frameworks, Java, or other languages such as C or C++.</span></span>
* <span data-ttu-id="6fd83-141">每個服務可以獨立地調整以回應負載的增加和減少。</span><span class="sxs-lookup"><span data-stu-id="6fd83-141">Each service can be independently scaled to respond to increases and decreases in load.</span></span>

> [!NOTE] 
> <span data-ttu-id="6fd83-142">多組織用戶管理超出此應用程式的重構範圍。</span><span class="sxs-lookup"><span data-stu-id="6fd83-142">Multitenancy is out of scope for the refactoring of this application.</span></span> <span data-ttu-id="6fd83-143">Tailspin 有數個選項可以支援多組織用戶管理，且稍後可以進行這些設計決策而不會影響最初的設計。</span><span class="sxs-lookup"><span data-stu-id="6fd83-143">Tailspin has several options to support multitenancy and can make these design decisions later without affecting the initial design.</span></span> <span data-ttu-id="6fd83-144">例如，Tailspin 可以為叢集內的每個租用戶建立服務的個別執行個體，或者為每個租用戶建立個別的叢集。</span><span class="sxs-lookup"><span data-stu-id="6fd83-144">For example, Tailspin can create separate instances of the services for each tenant within a cluster or create a separate cluster for each tenant.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="6fd83-145">設計考量</span><span class="sxs-lookup"><span data-stu-id="6fd83-145">Design considerations</span></span>
 
<span data-ttu-id="6fd83-146">下圖顯示重構成更細微架構之 Surveys 應用程式的架構：</span><span class="sxs-lookup"><span data-stu-id="6fd83-146">The following diagram shows the architecture of the Surveys application refactored to a more granular architecture:</span></span>

![](./images/surveys_03.png)

<span data-ttu-id="6fd83-147">**Tailspin.Web** 是自我裝載 ASP.NET MVC 應用程式的無狀態服務，Tailspin 客戶會造訪以建立問卷，並檢視問卷結果。</span><span class="sxs-lookup"><span data-stu-id="6fd83-147">**Tailspin.Web** is a stateless service self-hosting an ASP.NET MVC application that Tailspin customers visit to create surveys and view survey results.</span></span> <span data-ttu-id="6fd83-148">此服務會與來自移轉 Service Fabric 應用程式的 Tailspin.Web 服務共用它的大部分程式碼。</span><span class="sxs-lookup"><span data-stu-id="6fd83-148">This service shares most of its code with the *Tailspin.Web* service from the ported Service Fabric application.</span></span> <span data-ttu-id="6fd83-149">如先前所述，此服務會使用 ASP.NET Core，並且從使用 Kestrel 作為 Web 前端切換成實作 WebListener。</span><span class="sxs-lookup"><span data-stu-id="6fd83-149">As mentioned earlier, this service uses ASP.NET core and switches from using Kestrel as web frontend to implementing a WebListener.</span></span>

<span data-ttu-id="6fd83-150">**Tailspin.Web.Surveys.Public** 是無狀態服務，也會自我裝載 ASP.NET MVC 網站。</span><span class="sxs-lookup"><span data-stu-id="6fd83-150">**Tailspin.Web.Surveys.Public** is a stateless service also self-hosting an ASP.NET MVC site.</span></span> <span data-ttu-id="6fd83-151">使用者會造訪這個網站以從清單中選取問卷，然後填寫。此服務會與來自移轉 Service Fabric 應用程式的 Tailspin.Web.Survey.Public 服務共用它的大部分程式碼。</span><span class="sxs-lookup"><span data-stu-id="6fd83-151">Users visit this site to select surveys from a list and then fill them out. This service shares most of its code with the *Tailspin.Web.Survey.Public* service from the ported Service Fabric application.</span></span> <span data-ttu-id="6fd83-152">此服務會使用 ASP.NET Core，也會從使用 Kestrel 作為 Web 前端切換成實作 WebListener。</span><span class="sxs-lookup"><span data-stu-id="6fd83-152">This service also uses ASP.NET Core and also switches from using Kestrel as web frontend to implementing a WebListener.</span></span>

<span data-ttu-id="6fd83-153">**Tailspin.SurveyResponseService** 是具狀態服務，它會將問卷答案儲存在 Azure Blob 儲存體中。</span><span class="sxs-lookup"><span data-stu-id="6fd83-153">**Tailspin.SurveyResponseService** is a stateful service that stores survey answers in Azure Blob Storage.</span></span> <span data-ttu-id="6fd83-154">它也會將答案合併成問卷分析資料。</span><span class="sxs-lookup"><span data-stu-id="6fd83-154">It also merges answers into the survey analysis data.</span></span> <span data-ttu-id="6fd83-155">服務會實作為具狀態服務，因為它使用 [ReliableConcurrentQueue][reliable-concurrent-queue] 來批次處理問卷答案。</span><span class="sxs-lookup"><span data-stu-id="6fd83-155">The service is implemented as a stateful service because it uses a [ReliableConcurrentQueue][reliable-concurrent-queue] to process survey answers in batches.</span></span> <span data-ttu-id="6fd83-156">這項功能原本是在移轉的 Service Fabric 應用程式之 Tailspin.Web.Survey.Public 服務中實作。</span><span class="sxs-lookup"><span data-stu-id="6fd83-156">This functionality was originally implemented in the *Tailspin.Web.Survey.Public* service in the ported Service Fabric application.</span></span> <span data-ttu-id="6fd83-157">Tailspin 將原始功能重構成此服務，讓它可以獨立調整。</span><span class="sxs-lookup"><span data-stu-id="6fd83-157">Tailspin refactored the original functionality into this service to allow it to scale independently.</span></span>

<span data-ttu-id="6fd83-158">**Tailspin.SurveyManagementService** 是無狀態服務，它會儲存及擷取問卷和問卷問題。</span><span class="sxs-lookup"><span data-stu-id="6fd83-158">**Tailspin.SurveyManagementService** is a stateless service that stores and retrieves surveys and survey questions.</span></span> <span data-ttu-id="6fd83-159">服務會使用 Azure Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="6fd83-159">The service uses Azure Blob storage.</span></span> <span data-ttu-id="6fd83-160">這項功能原本也是在移轉的 Service Fabric 應用程式之 Tailspin.AnswerAnalysisService 服務中實作。</span><span class="sxs-lookup"><span data-stu-id="6fd83-160">This functionality was also originally implemented in the *Tailspin.AnswerAnalysisService* service in the ported Service Fabric application.</span></span> <span data-ttu-id="6fd83-161">Tailspin 將原始功能重構成此服務，讓它也可以獨立調整。</span><span class="sxs-lookup"><span data-stu-id="6fd83-161">Tailspin refactored the original functionality into this service to also allow it to scale independently.</span></span>

<span data-ttu-id="6fd83-162">**Tailspin.SurveyAnswerService** 是無狀態服務，它會擷取問卷答案和問卷分析。</span><span class="sxs-lookup"><span data-stu-id="6fd83-162">**Tailspin.SurveyAnswerService** is a stateless service that retrieves survey answers and survey analysis.</span></span> <span data-ttu-id="6fd83-163">服務也會使用 Azure Blob 儲存體。</span><span class="sxs-lookup"><span data-stu-id="6fd83-163">The service also uses Azure Blob storage.</span></span> <span data-ttu-id="6fd83-164">這項功能原本也是在移轉的 Service Fabric 應用程式之 Tailspin.AnswerAnalysisService 服務中實作。</span><span class="sxs-lookup"><span data-stu-id="6fd83-164">This functionality was also originally implemented in the *Tailspin.AnswerAnalysisService* service in the ported Service Fabric application.</span></span> <span data-ttu-id="6fd83-165">Tailspin 將原始功能重構成此服務，因為它預期負載較少，並且會使用較少的執行個體以節省資源。</span><span class="sxs-lookup"><span data-stu-id="6fd83-165">Tailspin refactored the original functionality into this service because it expects less load and wants to use fewer instances to conserve resources.</span></span>

<span data-ttu-id="6fd83-166">**Tailspin.SurveyAnalysisService** 是無狀態服務，它會將問卷答案摘要資料保存在 Redis 快取以進行快速擷取。</span><span class="sxs-lookup"><span data-stu-id="6fd83-166">**Tailspin.SurveyAnalysisService** is a stateless service that persists survey answer summary data in a Redis cache for quick retrieval.</span></span> <span data-ttu-id="6fd83-167">此服務是由 Tailspin.SurveyResponseService 在每次回答問卷時及新問卷答案資料合併到摘要資料中時呼叫。</span><span class="sxs-lookup"><span data-stu-id="6fd83-167">This service is called by the *Tailspin.SurveyResponseService* each time a survey is answered and the new survey answer data is merged in the summary data.</span></span> <span data-ttu-id="6fd83-168">此服務包含移轉的 Service Fabric 應用程式之 Tailspin.SurveyAnalysisService 服務中的剩餘功能。</span><span class="sxs-lookup"><span data-stu-id="6fd83-168">This service includes the functionality remaining in the *Tailspin.SurveyAnalysisService* service from the ported Service Fabric application.</span></span>

## <a name="stateless-versus-stateful-services"></a><span data-ttu-id="6fd83-169">無狀態服務和具狀態服務</span><span class="sxs-lookup"><span data-stu-id="6fd83-169">Stateless versus stateful services</span></span>

<span data-ttu-id="6fd83-170">Azure Service Fabric 支援下列程式設計模型：</span><span class="sxs-lookup"><span data-stu-id="6fd83-170">Azure Service Fabric supports the following programming models:</span></span>
* <span data-ttu-id="6fd83-171">客體可執行檔模型可讓任何可執行檔封裝為服務，並部署到 Service Fabric 叢集。</span><span class="sxs-lookup"><span data-stu-id="6fd83-171">The guest executable model allows any executable to be packaged as a service and deployed to a Service Fabric cluster.</span></span> <span data-ttu-id="6fd83-172">Service Fabric 會協調和管理客體可執行檔的執行。</span><span class="sxs-lookup"><span data-stu-id="6fd83-172">Service Fabric orchestrates and manages execution of the guest executable.</span></span>
* <span data-ttu-id="6fd83-173">容器模型可讓服務在容器映像中部署。</span><span class="sxs-lookup"><span data-stu-id="6fd83-173">The container model allows for deployment of services in container images.</span></span> <span data-ttu-id="6fd83-174">Service Fabric 支援在 Linux 核心容器以及 Windows Server 容器上方建立及管理容器。</span><span class="sxs-lookup"><span data-stu-id="6fd83-174">Service Fabric supports creation and and management of containers on top of Linux kernel contains as well as Windows Server containers.</span></span> 
* <span data-ttu-id="6fd83-175">可靠的服務程式設計模型可以建立無狀態服務或具狀態服務，這些服務會與所有 Service Fabric 平台功能整合。</span><span class="sxs-lookup"><span data-stu-id="6fd83-175">The reliable services programming model allows for the creation of stateless or stateful services that integrate with all Service Fabric platform features.</span></span> <span data-ttu-id="6fd83-176">具狀態服務可讓複寫狀態儲存在 Service Fabric 叢集。</span><span class="sxs-lookup"><span data-stu-id="6fd83-176">Stateful services allow for replicated state to be stored in the Service Fabric cluster.</span></span> <span data-ttu-id="6fd83-177">無狀態服務就沒有辦法。</span><span class="sxs-lookup"><span data-stu-id="6fd83-177">Stateless services do not.</span></span>
* <span data-ttu-id="6fd83-178">可靠的動作項目程式設計模型可以建立服務，這些服務會實作虛擬動作項目模式。</span><span class="sxs-lookup"><span data-stu-id="6fd83-178">The reliable actors programming model allows for the creation of services that implement the virtual actor pattern.</span></span>

<span data-ttu-id="6fd83-179">Surveys 應用程式中的所有服務都是可靠的無狀態服務，除了 Tailspin.SurveyResponseService 服務。</span><span class="sxs-lookup"><span data-stu-id="6fd83-179">All the services in the Surveys application are stateless reliable services, except for the *Tailspin.SurveyResponseService* service.</span></span> <span data-ttu-id="6fd83-180">此服務會實作 [ReliableConcurrentQueue][reliable-concurrent-queue] 以在收到問卷答案時進行處理。</span><span class="sxs-lookup"><span data-stu-id="6fd83-180">This service implements a [ReliableConcurrentQueue][reliable-concurrent-queue] to process survey answers when they are received.</span></span> <span data-ttu-id="6fd83-181">ReliableConcurrentQueue 中的回應會儲存到 Azure Blob 儲存體，並且傳遞給 Tailspin.SurveyAnalysisService 進行分析。</span><span class="sxs-lookup"><span data-stu-id="6fd83-181">Responses in the ReliableConcurrentQueue are saved into Azure Blob Storage and passed to the *Tailspin.SurveyAnalysisService* for analysis.</span></span> <span data-ttu-id="6fd83-182">Tailspin 選擇 ReliableConcurrentQueue，因為回應不需要由佇列 (例如 Azure 服務匯流排) 提供的嚴格先進先出 (FIFO) 順序。</span><span class="sxs-lookup"><span data-stu-id="6fd83-182">Tailspin chooses a ReliableConcurrentQueue based because responses do not require strict first-in-first-out (FIFO) ordering provided by a queue such as Azure Service Bus.</span></span> <span data-ttu-id="6fd83-183">ReliableConcurrentQueue 也設計為針對佇列和清除佇列作業提供高輸送量和低延遲。</span><span class="sxs-lookup"><span data-stu-id="6fd83-183">A ReliableConcurrentQueue is also designed to deliver high throughput and low latency for queue and dequeue operations.</span></span>

<span data-ttu-id="6fd83-184">請注意，保存來自 ReliableConcurrentQueue 之清除佇列項目的作業在理想情況下應該具有等冪性。</span><span class="sxs-lookup"><span data-stu-id="6fd83-184">Note that operations to persist dequeued items from a ReliableConcurrentQueue should ideally be idempotent.</span></span> <span data-ttu-id="6fd83-185">如果在處理來自佇列之項目的期間擲回例外狀況，可能是處理相同的項目超過一次。</span><span class="sxs-lookup"><span data-stu-id="6fd83-185">If an exception is thrown during the processing of an item from the queue, the same item may be processed more than once.</span></span> <span data-ttu-id="6fd83-186">在 Surveys 應用程式中，將問卷答案合併至 Tailspin.SurveyAnalysisService 的作業不是等冪，因為 Tailspin 決定問卷分析資料只是分析資料目前的快照集，不需要一致。</span><span class="sxs-lookup"><span data-stu-id="6fd83-186">In the Surveys application, the operation to merge survey answers to the *Tailspin.SurveyAnalysisService* is not idempotent because Tailspin decided that the survey analysis data is only a current snapshot of the analysis data and does not need to be consistent.</span></span> <span data-ttu-id="6fd83-187">儲存到 Azure Blob 儲存體中的問卷答案最終保持一致，因此問卷最終分析一定可以從這項資料正確重新計算。</span><span class="sxs-lookup"><span data-stu-id="6fd83-187">The survey answers saved to Azure Blob Storage are eventually consistent, so the survey final analysis can always be recalculated correctly from this data.</span></span>

## <a name="communication-framework"></a><span data-ttu-id="6fd83-188">通訊架構</span><span class="sxs-lookup"><span data-stu-id="6fd83-188">Communication framework</span></span>

<span data-ttu-id="6fd83-189">Surveys 應用程式中的每個服務都使用 RESTful Web API 來進行通訊。</span><span class="sxs-lookup"><span data-stu-id="6fd83-189">Each service in the Surveys application communicates using a RESTful web API.</span></span> <span data-ttu-id="6fd83-190">RESTful API 提供下列優點：</span><span class="sxs-lookup"><span data-stu-id="6fd83-190">RESTful APIs offer the following benefits:</span></span>
* <span data-ttu-id="6fd83-191">使用方便：每個服務都是使用 ASP.Net Core MVC 所建置，且原生支援 Web API 的建立。</span><span class="sxs-lookup"><span data-stu-id="6fd83-191">Ease of use: each service is built using ASP.Net Core MVC, which natively supports the creation of Web APIs.</span></span>
* <span data-ttu-id="6fd83-192">安全性：所有服務都不需要 SSL，但是 Tailspin 可以要求每個服務這樣做。</span><span class="sxs-lookup"><span data-stu-id="6fd83-192">Security: While each service does not require SSL, Tailspin could require each service to do so.</span></span> 
* <span data-ttu-id="6fd83-193">版本設定：用戶端可以根據特定版本的 Web API 撰寫及測試。</span><span class="sxs-lookup"><span data-stu-id="6fd83-193">Versioning: clients can be written and tested against a specific version of a web API.</span></span>

<span data-ttu-id="6fd83-194">Survey 應用程式中的服務會使用由 Service Fabric 實作的[反向 Proxy][reverse-proxy]。</span><span class="sxs-lookup"><span data-stu-id="6fd83-194">Services in the Survey application make use of the [reverse proxy][reverse-proxy] implemented by Service Fabric.</span></span> <span data-ttu-id="6fd83-195">反向 Proxy 是一項服務，它會在 Service Fabric 的每個節點上執行，並且提供端點解析、自動重試及處理其他類型的連線失敗。</span><span class="sxs-lookup"><span data-stu-id="6fd83-195">Reverse proxy is a service that runs on each node in the Service Fabric cluster and provides endpoint resolution, automatic retry, and handles other types of connection failures.</span></span> <span data-ttu-id="6fd83-196">若要使用反向 Proxy，對於特定服務之每個 RESTful API 呼叫是使用預先定義的反向 Proxy 連接埠來進行。</span><span class="sxs-lookup"><span data-stu-id="6fd83-196">To use the reverse proxy, each RESTful API call to a specific service is made using a predefined reverse proxy port.</span></span>  <span data-ttu-id="6fd83-197">例如，如果反向 Proxy 連接埠已設定為 **19081**，對於 Tailspin.SurveyAnswerService 的呼叫可以進行如下：</span><span class="sxs-lookup"><span data-stu-id="6fd83-197">For example, if the reverse proxy port has been set to **19081**, a call to the *Tailspin.SurveyAnswerService* can be made as follows:</span></span>

```csharp
static SurveyAnswerService()
{
    httpClient = new HttpClient
    {
        BaseAddress = new Uri("http://localhost:19081/Tailspin/SurveyAnswerService/")
    };
}
```
<span data-ttu-id="6fd83-198">若要啟用反向 Proxy，請於 Service Fabric 叢集建立期間指定反向 Proxy 連接埠。</span><span class="sxs-lookup"><span data-stu-id="6fd83-198">To enable reverse proxy, specify a reverse proxy port during creation of the Service Fabric cluster.</span></span> <span data-ttu-id="6fd83-199">如需詳細資訊，請參閱 Azure Service Fabric 中的[反向 Proxy][reverse-proxy]。</span><span class="sxs-lookup"><span data-stu-id="6fd83-199">For more information, see [reverse proxy][reverse-proxy] in Azure Service Fabric.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="6fd83-200">效能考量</span><span class="sxs-lookup"><span data-stu-id="6fd83-200">Performance considerations</span></span>

<span data-ttu-id="6fd83-201">Tailspin 會使用 Visual Studio 範本，為 Tailspin.Web 和 Tailspin.Web.Surveys.Public 建立 ASP.NET Core 服務。</span><span class="sxs-lookup"><span data-stu-id="6fd83-201">Tailspin created the ASP.NET Core services for *Tailspin.Web* and *Tailspin.Web.Surveys.Public* using Visual Studio templates.</span></span> <span data-ttu-id="6fd83-202">根據預設，這些範本包含主控台的記錄。</span><span class="sxs-lookup"><span data-stu-id="6fd83-202">By default, these templates include logging to the console.</span></span> <span data-ttu-id="6fd83-203">主控台的記錄可能是在開發和偵錯期間完成，但是主控台的所有記錄應該在應用程式部署到生產環境時移除。</span><span class="sxs-lookup"><span data-stu-id="6fd83-203">Logging to the console may be done during development and debugging, but all logging to the console should be removed when the application is deployed to production.</span></span>

> [!NOTE]
> <span data-ttu-id="6fd83-204">如需有關針對在生產環境中執行之 Service Fabric 應用程式設定監視和診斷的詳細資訊，請參閱適用於 Azure Service Fabric 的[監視和診斷][monitoring-diagnostics]。</span><span class="sxs-lookup"><span data-stu-id="6fd83-204">For more information about setting up monitoring and diagnostics for Service Fabric applications running in production, see [monitoring and diagnostics][monitoring-diagnostics] for Azure Service Fabric.</span></span>

<span data-ttu-id="6fd83-205">例如，針對每個 Web 前端服務之 startup.cs 中的下列行應該註解化：</span><span class="sxs-lookup"><span data-stu-id="6fd83-205">For example, the following lines in *startup.cs* for each of the web front end services should be commented out:</span></span>

```csharp
// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
    //loggerFactory.AddConsole(Configuration.GetSection("Logging"));
    //loggerFactory.AddDebug();

    app.UseMvc();
}
```

> [!NOTE]
> <span data-ttu-id="6fd83-206">發行時當 Visual Studio 設定為「發行」，可以有條件地排除這些行。</span><span class="sxs-lookup"><span data-stu-id="6fd83-206">These lines may be conditionally excluded when Visual Studio is set to “release” when publishing.</span></span>

<span data-ttu-id="6fd83-207">最後，當 Tailspin 將 Tailspin 應用程式部署到生產環境時，它們會將 Visual Studio 切換成**發行**模式。</span><span class="sxs-lookup"><span data-stu-id="6fd83-207">Finally, when Tailspin deploys the Tailspin application to production, they switch Visual Studio to **release** mode.</span></span>

## <a name="deployment-considerations"></a><span data-ttu-id="6fd83-208">部署考量</span><span class="sxs-lookup"><span data-stu-id="6fd83-208">Deployment considerations</span></span>

<span data-ttu-id="6fd83-209">重構的 Surveys 應用程式是由 5 個無狀態服務和 1 個具狀態服務所組成，因此叢集規劃受限為決定正確的 VM 大小和節點數目。</span><span class="sxs-lookup"><span data-stu-id="6fd83-209">The refactored Surveys application is composed of five stateless services and one stateful service, so cluster planning is limited to determining the correct VM size and number of nodes.</span></span> <span data-ttu-id="6fd83-210">在說明叢集的 applicationmanifest.xml 檔案中，Tailspin 為每個服務將 StatelessService 標記的 InstanceCount 屬性設為 -1。</span><span class="sxs-lookup"><span data-stu-id="6fd83-210">In the *applicationmanifest.xml* file that describes the cluster, Tailspin sets the *InstanceCount* attribute of the *StatelessService* tag to -1 for each of the services.</span></span> <span data-ttu-id="6fd83-211">值 -1 會指示 Service Fabric 在叢集的每個節點上建立服務的執行個體。</span><span class="sxs-lookup"><span data-stu-id="6fd83-211">A value of -1 directs Service Fabric to create an instance of the service on each node in the cluster.</span></span>

> [!NOTE]
> <span data-ttu-id="6fd83-212">具狀態服務需要為其資料規劃正確資料分割和複本數目的額外步驟。</span><span class="sxs-lookup"><span data-stu-id="6fd83-212">Stateful services require the additional step of planning the correct number of partitions and replicas for their data.</span></span>

<span data-ttu-id="6fd83-213">Tailspin 使用 Azure 入口網站來部署叢集。</span><span class="sxs-lookup"><span data-stu-id="6fd83-213">Tailspin deploys the cluster using the Azure Portal.</span></span> <span data-ttu-id="6fd83-214">Service Fabric 叢集資源類型會部署所有必要的基礎結構，包括 VM 擴展集和負載平衡器。</span><span class="sxs-lookup"><span data-stu-id="6fd83-214">The Service Fabric Cluster resource type deploys all of the necessary infrastructure, including VM scale sets and a load balancer.</span></span> <span data-ttu-id="6fd83-215">建議的 VM 大小會在針對 Service Fabric 叢集佈建程序期間顯示於 Azure 入口網站中。</span><span class="sxs-lookup"><span data-stu-id="6fd83-215">The recommended VM sizes are displayed in the Azure portal during the provisioning process for the Service Fabric cluster.</span></span> <span data-ttu-id="6fd83-216">請注意，因為 VM 是部署在 VM 擴展集中，它們可以隨著使用者負載增加而相應增加和相應放大。</span><span class="sxs-lookup"><span data-stu-id="6fd83-216">Note that because the VMs are deployed in a VM scale set, they can be both scaled up and out as user load increases.</span></span>

> [!NOTE]
> <span data-ttu-id="6fd83-217">如同先前的討論，在移轉版本的 Surveys 應用程式中，兩個 Web 前端是使用 ASP.Net Core 和 Kestrel 自我裝載為網頁伺服器。</span><span class="sxs-lookup"><span data-stu-id="6fd83-217">As discussed earlier, in the migrated version of the Surveys application the two web front ends were self-hosted using ASP.Net Core and Kestrel as a web server.</span></span> <span data-ttu-id="6fd83-218">雖然移轉的 Survey 應用程式未使用反向 Proxy，但是強烈建議使用反向 Proxy，例如 IIS、Nginx 或 Apache。</span><span class="sxs-lookup"><span data-stu-id="6fd83-218">While the migrated version of the Survey application does not use a reverse proxy, it is strongly recommended to use a reverse proxy such as IIS, Nginx, or Apache.</span></span> <span data-ttu-id="6fd83-219">如需詳細資訊，請參閱 [ASP.NET Core 中的 Kestrel 網頁伺服器實作簡介][kestrel-intro]。</span><span class="sxs-lookup"><span data-stu-id="6fd83-219">For more information see [introduction to Kestrel web server implementation in ASP.NET core][kestrel-intro].</span></span>
> <span data-ttu-id="6fd83-220">在重構的 Surveys 應用程式中，兩個 Web 前端會使用 ASP.Net Core 與[WebListener][weblistener] 自我裝載為網頁伺服器，因此不需要反向 Proxy。</span><span class="sxs-lookup"><span data-stu-id="6fd83-220">In the refactored Surveys application, the two web front ends are self-hosted using ASP.Net Core with [WebListener][weblistener] as a web server so a reverse proxy is not necessary.</span></span>

## <a name="next-steps"></a><span data-ttu-id="6fd83-221">後續步驟</span><span class="sxs-lookup"><span data-stu-id="6fd83-221">Next steps</span></span>

<span data-ttu-id="6fd83-222">Surveys 應用程式的程式碼可於 [GitHub][sample-code] 取得。</span><span class="sxs-lookup"><span data-stu-id="6fd83-222">The Surveys application code is available on [GitHub][sample-code].</span></span>

<span data-ttu-id="6fd83-223">如果您剛開始使用 [Azure Service Fabric][service-fabric]，請先設定開發環境，然後下載最新的 [Azure SDK][azure-sdk] 和 [Azure Service Fabric SDK][service-fabric-sdk]。</span><span class="sxs-lookup"><span data-stu-id="6fd83-223">If you are just getting started with [Azure Service Fabric][service-fabric], first set up your development environment then download the latest [Azure SDK][azure-sdk] and the [Azure Service Fabric SDK][service-fabric-sdk].</span></span> <span data-ttu-id="6fd83-224">SDK 包含 OneBox 叢集管理員，因此您可以使用完整的 F5 偵錯在本機部署及測試 Surveys 應用程式。</span><span class="sxs-lookup"><span data-stu-id="6fd83-224">The SDK includes the OneBox cluster manager so you can deploy and test the Surveys application locally with full F5 debugging.</span></span>

<!-- links -->
[azure-sdk]: https://azure.microsoft.com/en-us/downloads/archive-net-downloads/
[container-scenarios]: /azure/service-fabric/service-fabric-containers-overview
[kestrel]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore2x
[kestrel-intro]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/kestrel?tabs=aspnetcore1x
[migrate-from-cloud-services]: migrate-from-cloud-services.md
[monitoring-diagnostics]: /azure/service-fabric/service-fabric-diagnostics-overview
[reliable-concurrent-queue]: /azure/service-fabric/service-fabric-reliable-services-reliable-concurrent-queue
[reverse-proxy]: /azure/service-fabric/service-fabric-reverseproxy
[sample-code]: https://github.com/mspnp/cloud-services-to-service-fabric/tree/master/servicefabric-phase-2
[service-fabric]: /azure/service-fabric/service-fabric-get-started
[service-fabric-sdk]: /azure/service-fabric/service-fabric-get-started
[weblistener]: https://docs.microsoft.com/aspnet/core/fundamentals/servers/weblistener